<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Using the EPAS client library </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Using the EPAS client library ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/westpay.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html" style='padding-top:13px'>
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../articles/intro.html" title="Articles">Articles</a>
                      </li>
                      <li>
                          <a href="../api/index.html" title="API Documentation">API Documentation</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="intro.html" title="Introduction" class="">Introduction</a>
                    </li>
                    <li class="">
                      <a href="additional.html" title="Additional features" class="">Additional features</a>
                    </li>
                    <li class="">
                      <a href="apm.html" title="Alternative payment methods" class="">Alternative payment methods</a>
                    </li>
                    <li class="">
                      <a href="dcc.html" title="Dynamic Currency Conversion" class="">Dynamic Currency Conversion</a>
                    </li>
                    <li class="">
                      <a href="identifying_cards.html" title="Identifying cards" class="">Identifying cards</a>
                    </li>
                    <li class="">
                      <a href="integrating_the_library.html" title="Integrating the EPAS Client Library" class="">Integrating the EPAS Client Library</a>
                    </li>
                    <li class="">
                      <a href="multi_tid.html" title="Using Multiple Terminal IDs" class="">Using Multiple Terminal IDs</a>
                    </li>
                    <li class="">
                      <a href="log_storage.html" title="Log storage" class="">Log storage</a>
                    </li>
                    <li class="">
                      <a href="receipts.html" title="Receipts" class="">Receipts</a>
                    </li>
                    <li class="">
                      <a href="release_notes.html" title="Release notes" class="">Release notes</a>
                    </li>
                    <li class="">
                      <a href="transactions.html" title="Transaction types" class="">Transaction types</a>
                    </li>
                    <li class="">
                      <a href="transaction_flows.html" title="Transaction examples" class="">Transaction examples</a>
                    </li>
                    <li class="active">
                      <a href="using_the_library.html" title="Using the EPAS Client Library" class="active">Using the EPAS Client Library</a>
                    </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="using-the-epas-client-library">Using the EPAS client library</h1>

<h2 id="connecting-to-the-terminal">Connecting to the terminal</h2>
<p>After <a href="integrating_the_library.html">initialisation</a>, the first step for the ECR is to connect to the terminal.</p>
<p>Use the <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_ConnectNetwork_Westpay_Epas_TerminalNetworkConnection_System_Boolean_">ConnectNetwork</a> method to connect.</p>
<pre><code class="lang-csharp">void ConnectToTerminal()
{
    TerminalNetworkConnection tc = new TerminalNetworkConnection();
    tc.TerminalConnectionDetails = new IPEndPoint(IPAddress.Parse(txtTerminalAddress.Text),
                                                                  int.Parse(txtTerminalPort.Text));
    tc.UseKeepAlive = optKeepalive.Checked;

    ApiResult result = mEpas.ConnectNetwork(tc, optForceReconnect.Checked);
    LogApiResult(result, &quot;Connect&quot;);
}
</code></pre><p>There is a <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Disconnect">Disconnect</a> method that can be used to
disconnect from the terminal, but it is not required. The terminal will automatically detect if the connection has been lost.</p>
<p>When the client library loses connection with a terminal the <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_LinkStatus">LinkStatus</a> callback will be called if it has been defined.</p>
<blockquote><p><strong>Note:</strong> The client library does not support automatic reconnection. </p>
<p>The library has no way of knowing if the disconnection was intentional or not, or if is something that will be resolved quickly or 
not, so it has no way to know if automatic reconnection is a good idea. If the ECR wishes to handle a disconnection, therefore, it should handle the LinkStatus callback.</p>
<p>If the link goes down then the terminal will do two things:</p>
<ul>
<li>Abort any transaction that is ongoing, and</li>
<li>Perform an automatic log out.</li>
</ul>
<p>When the ECR wishes to reconnect, therefore, it should:</p>
<ul>
<li>Call the appropriate connection method (see above).</li>
<li>Call the <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Login_Westpay_Epas_TerminalEnvironment_Westpay_Epas_LoginResponse__">Login</a> method.</li>
</ul>
</blockquote>
<h2 id="logging-in">Logging in</h2>
<p>The ECR must log in to the terminal before it can run any transactions. The login includes necessary details 
about the terminal. See <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Login_Westpay_Epas_TerminalEnvironment_Westpay_Epas_LoginResponse__">Login</a>.</p>
<pre><code class="lang-csharp">void LoginToTerminal()
{
    TerminalEnvironment te = new TerminalEnvironment()
    {
        AuthorisationServer = new IPEndPoint(IPAddress.Parse(&quot;185.27.171.42&quot;), 55144),
        ConfigurationServer = new IPEndPoint(IPAddress.Parse(&quot;185.27.171.42&quot;), 55133),
        ISO639_1_LanguageCode = TerminalEnvironment.LangSwedish,
        OperatorId = &quot;cashier_1&quot;,
        TerminalId = &quot;80000082&quot;
    };

    if (epas.Login(te, out LoginResponse lr) == ApiResult.OK)
    {
        if (lr.LoggedIn)
        {
            ...
        }
    }
}
</code></pre><blockquote><p><strong>Note</strong>: The ECR only needs to log in once. There is no need to log in for every transaction.</p>
</blockquote>
<p>The ECR can log out as well, but there is rarely any need to do so, unless the ECR needs to change some of the terminal options, like the terminal ID. See <a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Logout_Westpay_Epas_LogoutResponse__">Logout</a>.</p>
<blockquote><p><strong>Note</strong>: If the terminal is disconnected, it is automatically logged out.</p>
</blockquote>
<h2 id="transactions">Transactions</h2>
<p>When the library is connected and logged in, it is ready to perform transactions with the terminal.</p>
<p>The EPAS client library offers several transaction methods, of which the most basic is 
<a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Purchase_System_Decimal_Westpay_Epas_TransactionResponse__">Purchase</a>,
which can be used like this:</p>
<pre><code class="lang-csharp">public void SimplePurchase(decimal amount)
{
    Log(&quot;Simple purchase of &quot; + string.Format(&quot;{0:.00}&quot;, amount));
    TransactionResponse response;
    ApiResult result = mEpas.Purchase(amount, out response);
    if (result == ApiResult.OK)
    {
        HandleTxnResponse(response);
    }
    LogApiResult(result, &quot;Simple purchase: &quot; + response?.ToString());
}
</code></pre><p>Each transaction is synchronous, so the method will return when the transaction is complete. This can take some time, since it involves waiting for a card to be presented, waiting for PIN entry, etc.</p>
<p>Some of the methods in <a class="xref" href="../api/Westpay.Epas.IClientApp.html">IClientApp</a> will be called while the transaction is in progress. Similarly some of the optional handler methods will be called, if defined. All these methods will be called from a different thread to the one that is executing the transaction so there is no risk of deadlock in the callback mechanism.</p>
<h2 id="transaction-types">Transaction types</h2>
<p>See the <a href="transactions.html">transactions</a> page for more details on how to perform different types of transactions.</p>
<p>The <a href="transaction_flows.html">examples</a> page contains examples of different transactions.</p>
<h1 id="configuration">Configuration</h1>
<p>There are some configuration options in the client library. These are defined in the library’s
<a class="xref" href="../api/Westpay.Epas.EpasClient.html#Westpay_Epas_EpasClient_Options">Options</a> property,
which is an instance of the <a class="xref" href="../api/Westpay.Epas.OperatingParameters.html">OperatingParameters</a> class.</p>
<h1 id="notes-on-the-api">Notes on the API</h1>
<h2 id="calling-api-methods">Calling API methods</h2>
<p>API calls into the library are always synchronous. When a purchase transaction is called, for example, the method does not return
until the transaction has ended. In general, therefore, it is best for the ECR software to avoid calling API methods from the
user interface thread</p>
<h3 id="return-values">Return values</h3>
<p>Most library methods return an <a class="xref" href="../api/Westpay.Epas.ApiResult.html">ApiResult</a> value. These are related to the operation of the
library, the communications link, and the protocols involved. They are not directly related to transactions or other 
high-level operations.</p>
<blockquote><p><strong>Note:</strong> a return value of <code>ApiResult.OK</code> only indicates that the low level communications and messaging was successful.
It does not, for example, indicate that a transaction was approved.</p>
</blockquote>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
